# route_numbers = [1, 7, 10, 20, 30, 105, 142, 80]  # Example route numbers


import folium
import json
from shapely.geometry import shape, Point
from branca.element import Template, MacroElement
import geopandas as gpd

# Initialize the map and set its location to Austin's coordinates
map_austin = folium.Map(location=[30.32846707645551, -97.70014422880493], zoom_start=12)

# Load your shapefile and transform CRS if necessary
routes = gpd.read_file('Routes.shp')
if routes.crs != 'EPSG:4326':
    routes = routes.to_crs('EPSG:4326')

# Filter routes by ROUTE_ID
selected_route_ids = [1, 7, 10, 20, 30, 105, 142, 80]
filtered_routes = routes[routes['ROUTE_ID'].isin(selected_route_ids)]

# Convert datetime columns to string
for col in filtered_routes.select_dtypes(include=['datetime']).columns:
    filtered_routes[col] = filtered_routes[col].astype(str)

# Keep only necessary columns
necessary_columns = ['ROUTE_ID', 'ROUTENAME', 'geometry', 'ROUTECOLOR']
filtered_routes = filtered_routes[necessary_columns]

# Convert to GeoJSON
filtered_routes_json = filtered_routes.to_json()

# Example of applying conditional color by ROUTE_ID
def style_function(feature):
    colors = {
        1: 'red', 7: 'blue', 10: 'green', 20: 'yellow', 30: 'purple',
        105: 'orange', 142: 'pink', 80: 'grey'  
    }
    return {
        'color': colors.get(feature['properties']['ROUTE_ID'], '#000000'),
        'weight': 3 if feature["properties"]["ROUTE_ID"] in [1, 7, 80] else 2,  # Thicker lines for main routes
        'opacity': 0.9 if feature["properties"]["ROUTE_ID"] in [1, 7, 80] else 0.6
    }

bus_routes_layer = folium.GeoJson(
    filtered_routes.to_json(),
    name='Bus Routes',
    style_function=style_function
).add_to(map_austin)

# Create a custom legend using HTML and CSS
legend_html = """
<div style="position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: auto; height: auto; background-color: white; border-bottom: 1px solid grey; z-index:9999; font-size:12px; padding: 5px; text-align: center;">
    <strong>Bus Legend</strong>
    <div style="display: flex; justify-content: center; overflow-x: auto; white-space: nowrap;">
        <span style="background-color: red; color: black; padding: 2px 5px; margin-right: 5px;">1</span>
        <span style="background-color: blue; color: white; padding: 2px 5px; margin-right: 5px;">7</span>
        <span style="background-color: green; color: black; padding: 2px 5px; margin-right: 5px;">10</span>
        <span style="background-color: yellow; color: black; padding: 2px 5px; margin-right: 5px;">20</span>
        <span style="background-color: purple; color: white; padding: 2px 5px; margin-right: 5px;">30</span>
        <span style="background-color: orange; color: black; padding: 2px 5px; margin-right: 5px;">105</span>
        <span style="background-color: pink; color: black; padding: 2px 5px; margin-right: 5px;">142</span>
        <span style="background-color: grey; color: black; padding: 2px 5px; margin-right: 5px;">80</span>
    </div>
</div>


"""

# Add the legend to the map
map_austin.get_root().html.add_child(folium.Element(legend_html))

# Filter the GeoJSON data for specific Austin area zip codes
austin_zip_codes = [
    "78610", "78613", "78617", "78641", "78652", "78653", "78660", "78664", "78681",
    "78701", "78702", "78703", "78704", "78705", "78712", "78717", "78719", "78721",
    "78722", "78723", "78724", "78725", "78726", "78727", "78728", "78729", "78730",
    "78731", "78732", "78733", "78734", "78735", "78736", "78737", "78738", "78739",
    "78741", "78742", "78744", "78745", "78746", "78747", "78748", "78749", "78750",
    "78751", "78752", "78753", "78754", "78756", "78757", "78758", "78759"
]

# Filter for only these zip codes and calculate centroids
filtered_geojson = {
    "type": "FeatureCollection",
    "features": []
}

for feature in geojson_data['features']:
    if feature['properties']['ZCTA5CE10'] in austin_zip_codes:
        # Calculate the centroid of the polygon
        geom = shape(feature['geometry'])
        centroid = geom.centroid.coords[0]  # (longitude, latitude)
        feature['properties']['centroid'] = centroid
        filtered_geojson['features'].append(feature)

        # Create marker for the centroid
        folium.Marker(
            [centroid[1], centroid[0]],  # flip coords to latitude, longitude
            icon=folium.DivIcon(
                icon_size=(200, 36),
                icon_anchor=(100, 18),
                html=f'<div style="font-size: 12pt; text-align: center; color: gray;">{feature["properties"]["ZCTA5CE10"]}</div>',
            )
        ).add_to(map_austin)

# Add the GeoJSON as an overlay
zip_code_overlay = folium.GeoJson(
    filtered_geojson,
    name='Austin Zip Codes',
    style_function=lambda x: {
        'fillColor': 'none',
        'color': 'gray',
        'weight': 2,
        'fillOpacity': 0
    },
    show=True  
).add_to(map_austin)

# HTML content for the header of the map, with two columns of links
header_html = '''
    <div style="position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 400px; background-color: rgba(255,255,255,0.8); z-index:9999;
            padding: 10px; border-radius: 10px; border: 1px solid grey; text-align: center;">
    <h4>Austin Mutual Aid Winter Activation</h4>
    <h5><i>Updated 1/13/25 @ 4pm</i></h5>
    <table style="width:100%; text-align:left; margin-bottom: 5px;">
        <tr>
            <td>
                <ul>
                    <li><a href="https://example.com/link1" target="_blank">Dummy Link 1</a></li>
                    <li><a href="https://example.com/link2" target="_blank">Dummy Link 2</a></li>
                    <li><a href="https://www.facebook.com/groups/1043810232661482" target="_blank">AMA FB</a></li>
                </ul>
            </td>
            <td>
                <ul>
                    <li><a href="https://docs.google.com/spreadsheets/d/1uEj9iL9DJyCstrmy2Y1aPkhjR0hJp0iSQnIG4OnXj4E/edit?gid=0#gid=0" target="_blank">Cooking Signup</a></li>
                    <li><a href="https://example.com/volunteer" target="_blank">Volunteer Sign Up</a></li>
                    <li><a href="https://forms.gle/2BSR7WQ8PNxe4DSY7" target="_blank">Submit Volunteer Hours</a></li>
                </ul>
            </td>
        </tr>
    </table>
    <div style="display: flex; justify-content: space-evenly;">
        <div><img src="https://raw.githubusercontent.com/Kentroth/maps/refs/heads/main/pngimg.com%20-%20beehive_PNG1.png" style="width:24px; height:24px; vertical-align: middle;"> <span>AMA Hives</span></div>
        <div><img src="https://openclipart.org/download/266028/ChurchAvatar.svg" style="width:24px; height:24px; vertical-align: middle;"> <span>Shelter</span></div>
        <div><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRNKVS3fH5bkKr59LkSd66wO_ljAukXwHWP3Q&s" style="width:24px; height:24px; vertical-align: middle;"> <span>Donation Drop-off</span></div>
    </div>
</div>
'''

map_austin.get_root().html.add_child(folium.Element(header_html))

# Data for each marker
# East Side Hub
marker_data = [
    {
        'location': [30.272010280064286, -97.71751153105374],
        'icon': 'https://raw.githubusercontent.com/Kentroth/maps/refs/heads/main/pngimg.com%20-%20beehive_PNG1.png',
        'popup': """
            <b>East Hive</b><br>
            (Location Not Exact)<br> 
            <br>
            <i>Updated 1/13/24</i><br>
            <br>
            <strong><u>Volunteers Needed</u></strong><br>
            Sorting, cooking, distro <br>
            <br>
            <strong>Contact Info:</strong><br>
            • Slack: @HiveEast<br>
            • Signal: @HiveEast
            """
    }
,
# South Hub
    {
        'location': [30.21697525907292, -97.77885107469896], 
        'icon': 'https://raw.githubusercontent.com/Kentroth/maps/refs/heads/main/pngimg.com%20-%20beehive_PNG1.png',
        'popup': """
            <b>South Hive</b><br>
            (Location Not Exact)<br> 
            <br>
            <i>Updated 1/13/24</i><br>
            <br>
            <strong><u>Volunteers Needed</u></strong><br>
            Sorting, cooking, distro <br>
            <br>
            <strong>Contact Info:</strong><br>
            • Slack: @HiveSouth<br>
            • Signal: @HiveSouth
            """
    },
# Central Hub
    {
        'location': [30.319074618816682, -97.72829152295382], 
        'icon': 'https://raw.githubusercontent.com/Kentroth/maps/refs/heads/main/pngimg.com%20-%20beehive_PNG1.png',
        'popup': """
            <b>Central Hive</b><br>
            (Location Not Exact)<br> 
            <br>
            <i>Updated 1/13/24</i><br>
            <br>
            <strong><u>Volunteers Needed</u></strong><br>
            Sorting, cooking, distro <br>
            <br>
            <strong>Contact Info:</strong><br>
            • Slack: @HiveCentral<br>
            • Signal: @HiveCentral
            """
    },
# North Hub
    {'location': [30.41353953568781, -97.68427925143202], 
     'icon': 'https://raw.githubusercontent.com/Kentroth/maps/refs/heads/main/pngimg.com%20-%20beehive_PNG1.png',
        'popup': """
            <b>North Hive</b><br>
            (Location Not Exact)<br> 
            <br>
            <i>Updated 1/13/24</i><br>
            <br>
            <strong><u>Volunteers Needed</u></strong><br>
            Sorting, cooking, distro <br>
            <br>
            <strong>Contact Info:</strong><br>
            • Slack: @HiveNorth<br>
            • Signal: @HiveNorth
            """
    },
{
    'location': [30.38048881364346, -97.68539882034327],
    'icon': 'https://openclipart.org/download/266028/ChurchAvatar.svg',
    'popup': """
            <i>Updated 1/13/25 @ 4:45pm</i><br>
            <b>St Mark United Methodist Church</b><br>
            601 W Braker Ln, Austin, TX 78753<br>
            <strong>Hours:</strong><br>
            Mon-Fri: Check in 6pm<br>
            <a href="https://example.com/volunteer" target="_blank">Volunteer Sign Up</a> <br>
            <strong>Donations Needed:</strong><br>
            &nbsp;&nbsp;• Food (non-perishable items preferred)<br>
            &nbsp;&nbsp;• Clothing (in good condition for all ages and sizes)<br>
            &nbsp;&nbsp;• Blankets<br>
            <strong>Contact Information:</strong><br>
            Pierre Nguyễn<br>
            512-599-7883<br>
            pierre.nguyen@maritime.edu
            """,
            }
,
    
    {'location': [30.317052810379195, -97.69242430622069], 
     'icon': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRNKVS3fH5bkKr59LkSd66wO_ljAukXwHWP3Q&s', 
     'popup': ('<b>Memorial United Methodist Church</b> <br>'
          '6100 Berkman Dr, Austin, TX 78723 <br>'
          '<b>Donations:</b> <br> Hours: ---- <br>'
          'Contact: 555-555-5555 <br>'
          'Volunteers Needed:  <br>')},
    {'location': [30.278788809077557, -97.68693683558189], 
     'icon': 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRNKVS3fH5bkKr59LkSd66wO_ljAukXwHWP3Q&s', 
     'popup': '<b>Hungry Hill Foundation</b> <br> 1189 Springdale Rd <br> Austin, TX 78721 <b> Donations: <br> Hours: ---- <br> Contact: '},
    {'location': [30.257592812963843, -97.74918424232771], 
     'icon': 'https://images.rawpixel.com/image_png_social_square/cHJpdmF0ZS9sci9pbWFnZXMvd2Vic2l0ZS8yMDIyLTA1L2pvYjcyOC0xNzUtcC5wbmc.png', 
     'popup': '<b>One Texas Center</b> <br> Redirects people to city shelters during activations'}
]


# Add markers to the map
for data in marker_data:
    icon = folium.CustomIcon(
        icon_image=data['icon'],
        icon_size=(37, 37),  # Size of the image
        icon_anchor=(15, 30),  # Anchor point
    )
    folium.Marker(
        location=data['location'],
        icon=icon,
        popup=folium.Popup(data['popup'], max_width=200)
    ).add_to(map_austin)

folium.LayerControl().add_to(map_austin)

# Save the map to an HTML file
map_austin.save('map.html')
